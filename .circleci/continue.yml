version: 2.1

parameters:
  run_contracts:
    type: boolean
    default: false
  run_app:
    type: boolean
    default: false
  run_all:
    type: boolean
    default: false

jobs:
  contracts:
    docker:
      - image: cimg/node:22.18
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: Run contract coverage
          command: npm run coverage
      - run:
          name: Upload coverage
          command: npx codecov

  slither:
    docker:
      - image: cimg/node:22.18
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: Install Slither
          command: |
            sudo apt-get update && sudo apt-get install -y pipx
            pipx install slither-analyzer
            pipx install solc-select
            echo 'export PATH="$PATH:/home/circleci/.local/bin"' >> $BASH_ENV
            export PATH="$PATH:/home/circleci/.local/bin"
      - run:
          name: Run Slither (CI-safe)
          command: npm run slither:ci

  app:
    docker:
      - image: cimg/node:22.18
    steps:
      - checkout
      - run: npm ci
      - run:
          name: Run contract tests
          command: npm test
      - run: npm run compile
      - run: npm --prefix backend ci
      - run: npm --prefix frontend ci
      - run: npm --prefix backend run typecheck
      - run: npm --prefix frontend run typecheck
      # - run:
      #     name: Install Playwright system dependencies
      #     command: |
      #       cd frontend
      #       sudo npx playwright install-deps
      # - run:
      #     name: Install Playwright browsers
      #     command: npm --prefix frontend exec playwright install
      # - run: npm --prefix backend test
      # - run: npm --prefix backend run lint
      # - run: npm --prefix frontend test -- --reporter verbose
      # - run: npm --prefix frontend run lint
      # - run: npm --prefix frontend run build
      # - run: npm --prefix frontend run test:e2e

workflows:
  contracts:
    when: << pipeline.parameters.run_contracts >>
    jobs:
      - contracts:
          filters:
            branches:
              ignore: main
      - slither:
          filters:
            branches:
              ignore: main

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Telegram Group Access</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 960px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            text-align: center;
        }

        .price-display {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .price-amount {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .price-breakdown {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
        }

        .price-item {
            text-align: center;
        }

        .price-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .price-value {
            font-size: 24px;
            font-weight: bold;
        }

        .treasury {
            color: #28a745;
        }

        .burn {
            color: #dc3545;
        }

        .steps {
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step.active .step-number,
        .step.completed .step-number {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .step-description {
            font-size: 14px;
            opacity: 0.9;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.success {
            background: #28a745;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .info-label {
            color: #6c757d;
            font-size: 14px;
        }

        .info-value {
            font-weight: 600;
            color: #333;
        }

        .username-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .username-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status-message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
            display: block;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .network-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .network-badge.mainnet {
            background: #28a745;
            color: white;
        }

        .network-badge.testnet {
            background: #ffc107;
            color: #333;
        }

        .contract-info {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            font-size: 12px;
            color: #6c757d;
            text-align: center;
        }

        .contract-address {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .success-message {
            text-align: center;
            display: none;
        }

        .success-icon {
            font-size: 72px;
            margin-bottom: 20px;
        }

        .help-text {
            font-size: 14px;
            color: #6c757d;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Purchase Group Access</h1>
        <div class="subtitle">
            Complete all steps to join the exclusive Telegram group
            <span id="networkBadge" class="network-badge" style="display: none;"></span>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <div class="price-display">
            <div class="price-amount" id="priceAmount">Loading...</div>
            <div style="color: #6c757d; margin-bottom: 10px;">Entry Fee</div>
            <div class="price-breakdown">
                <div class="price-item">
                    <div class="price-label">Treasury</div>
                    <div class="price-value treasury" id="treasuryAmount">Loading...</div>
                </div>
                <div class="price-item">
                    <div class="price-label">Burned</div>
                    <div class="price-value burn" id="burnAmount">Loading...</div>
                </div>
            </div>
        </div>

        <div class="steps">
            <div class="step active" id="step1">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="step-title">Connect Wallet</div>
                    <div class="step-description">Connect your Web3 wallet to continue</div>
                </div>
            </div>

            <div class="step" id="step2">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="step-title">Approve Tokens</div>
                    <div class="step-description">Allow the contract to use your tokens</div>
                </div>
            </div>

            <div class="step" id="step3">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="step-title">Purchase Access</div>
                    <div class="step-description">Pay the entry fee to get access</div>
                </div>
            </div>

            <div class="step" id="step4">
                <div class="step-number">4</div>
                <div class="step-content">
                    <div class="step-title">Enter Username</div>
                    <div class="step-description">Provide your Telegram username</div>
                </div>
            </div>
        </div>

        <div id="walletSection">
            <button id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
        </div>

        <div id="tokenSection" style="display: none;">
            <div class="info-box">
                <div class="info-row">
                    <span class="info-label">Your Balance:</span>
                    <span class="info-value" id="tokenBalance">0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Approved Amount:</span>
                    <span class="info-value" id="tokenAllowance">0</span>
                </div>
            </div>
            <button id="approveBtn" onclick="approveTokens()" disabled>Approve Tokens</button>
            <button id="purchaseBtn" onclick="purchaseAccess()" disabled>Purchase Access</button>
        </div>

        <div id="usernameSection" style="display: none;">
            <input type="text" 
                   id="telegramUsername" 
                   class="username-input" 
                   placeholder="Enter your Telegram username (without @)"
                   pattern="[a-zA-Z0-9_]{5,32}">
            <button id="submitBtn" onclick="submitUsername()">Submit Username</button>
            <p class="help-text">
                Make sure your Telegram privacy settings allow invitations from contacts.
            </p>
        </div>

        <div id="successMessage" class="success-message">
            <div class="success-icon">ðŸŽ‰</div>
            <h2>Success!</h2>
            <p>You will receive a Telegram group invitation shortly.</p>
            <p class="help-text" style="margin-top: 20px;">
                If you don't receive an invitation, check your privacy settings.
            </p>
        </div>

        <div class="contract-info">
            <div>Contract: <span class="contract-address" id="contractAddress"></span></div>
            <div>Token: <span class="contract-address" id="tokenAddress"></span></div>
        </div>
    </div>

    <script>
        // Configuration
        let contractAddress = '';
        let tokenAddress = '';
        let entryFee = '420';
        let provider, signer, contract, tokenContract;
        let walletAddress, tokenDecimals, tokenSymbol;
        let hasUserPurchased = false;
        let sessionToken = null;

        const API_URL = window.location.origin;

        // Contract ABIs
        const CONTRACT_ABI = [
            "function purchaseAccess() external",
            "function hasAccess(address user) view returns (bool)",
            "function getConfig() view returns (address token, uint256 fee, bool isPaused, uint256 purchases, uint256 treasury)",
            "function getPurchaseDetails(address user) view returns (bool purchased, uint256 timestamp, uint256 blockNum)"
        ];

        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)"
        ];

        // Initialize
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            contractAddress = urlParams.get('contract');
            
            if (!contractAddress) {
                showStatus('error', 'No contract address provided. Add ?contract=0x... to URL');
                return;
            }

            document.getElementById('contractAddress').textContent = 
                contractAddress.slice(0, 6) + '...' + contractAddress.slice(-4);

            // Fetch contract info
            await fetchContractInfo();

            // Check if wallet is already connected
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        }

        async function fetchContractInfo() {
            try {
                // Use public RPC to fetch contract config
                const publicProvider = new ethers.JsonRpcProvider('https://mainnet.base.org');
                const readContract = new ethers.Contract(contractAddress, CONTRACT_ABI, publicProvider);
                
                const config = await readContract.getConfig();
                tokenAddress = config[0];
                entryFee = config[1].toString();
                
                console.log('Contract config - Entry fee raw value:', entryFee);
                
                // Display token address
                document.getElementById('tokenAddress').textContent = 
                    tokenAddress.slice(0, 6) + '...' + tokenAddress.slice(-4);
                
                // Get token info
                const tokenReadContract = new ethers.Contract(tokenAddress, ERC20_ABI, publicProvider);
                let decimals = 18; // Default
                let symbol = 'TOKEN'; // Default
                
                try {
                    decimals = await tokenReadContract.decimals();
                    symbol = await tokenReadContract.symbol();
                } catch (e) {
                    console.log('Using default decimals/symbol for token');
                }
                
                // The contract's entryFee is already in wei (2 = 2 wei)
                console.log('Fee in wei:', entryFee);
                
                // For display, format the wei amount with decimals
                const formattedFee = ethers.formatUnits(entryFee, decimals);
                document.getElementById('priceAmount').textContent = formattedFee + ' ' + symbol;
                document.getElementById('treasuryAmount').textContent = (parseFloat(formattedFee) / 2) + ' ' + symbol;
                document.getElementById('burnAmount').textContent = (parseFloat(formattedFee) / 2) + ' ' + symbol;
                
            } catch (error) {
                console.error('Error fetching contract info:', error);
                showStatus('warning', 'Could not fetch contract info. Using defaults.');
            }
        }

        async function connectWallet() {
            const connectBtn = document.getElementById('connectBtn');
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<span class="loading"></span>';

            try {
                if (!window.ethereum) {
                    throw new Error('Please install MetaMask or another Web3 wallet');
                }

                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Create provider and signer
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                walletAddress = await signer.getAddress();

                // Check network and switch to BASE if needed
                const network = await provider.getNetwork();
                const networkBadge = document.getElementById('networkBadge');
                
                if (network.chainId !== 8453n) {
                    showStatus('warning', 'Please switch to BASE network (Chain ID: 8453)');
                    
                    // Try to switch to BASE
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x2105' }], // 8453 in hex
                        });
                        // Re-initialize after switch
                        provider = new ethers.BrowserProvider(window.ethereum);
                        signer = await provider.getSigner();
                        const newNetwork = await provider.getNetwork();
                        networkBadge.textContent = 'BASE';
                        networkBadge.className = 'network-badge mainnet';
                    } catch (switchError) {
                        // This error code indicates that the chain has not been added to MetaMask
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x2105',
                                        chainName: 'Base',
                                        nativeCurrency: {
                                            name: 'Ethereum',
                                            symbol: 'ETH',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://mainnet.base.org'],
                                        blockExplorerUrls: ['https://basescan.org']
                                    }],
                                });
                                // Re-initialize after adding
                                provider = new ethers.BrowserProvider(window.ethereum);
                                signer = await provider.getSigner();
                                networkBadge.textContent = 'BASE';
                                networkBadge.className = 'network-badge mainnet';
                            } catch (addError) {
                                throw new Error('Please add BASE network to your wallet');
                            }
                        } else {
                            throw new Error('Please switch to BASE network');
                        }
                    }
                } else {
                    networkBadge.textContent = 'BASE';
                    networkBadge.className = 'network-badge mainnet';
                }
                networkBadge.style.display = 'inline-block';

                // Initialize contracts
                contract = new ethers.Contract(contractAddress, CONTRACT_ABI, signer);
                
                // Get token address from contract if not already set
                if (!tokenAddress) {
                    const config = await contract.getConfig();
                    tokenAddress = config[0];
                }
                
                tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);
                
                // Try to get decimals and symbol, use defaults if it fails
                try {
                    tokenDecimals = await tokenContract.decimals();
                    tokenSymbol = await tokenContract.symbol();
                } catch (e) {
                    console.log('Using default decimals/symbol');
                    tokenDecimals = 18;
                    tokenSymbol = 'TOKEN';
                }

                // Check if user already purchased
                hasUserPurchased = await contract.hasAccess(walletAddress);

                // Show token section
                document.getElementById('tokenSection').style.display = 'block';
                await updateBalances();

                if (hasUserPurchased) {
                    // Skip to username entry
                    markStepCompleted(1);
                    markStepCompleted(2);
                    markStepCompleted(3);
                    activateStep(4);
                    document.getElementById('usernameSection').style.display = 'block';
                    document.getElementById('tokenSection').style.display = 'none';
                    showStatus('success', 'You have already purchased access. Enter your Telegram username.');
                } else {
                    markStepCompleted(1);
                    activateStep(2);
                    document.getElementById('approveBtn').disabled = false;
                }

                connectBtn.textContent = 'Connected';
                connectBtn.classList.add('success');

            } catch (error) {
                console.error('Connection error:', error);
                showStatus('error', 'Failed to connect: ' + error.message);
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect Wallet';
            }
        }

        async function updateBalances() {
            try {
                const balance = await tokenContract.balanceOf(walletAddress);
                const allowance = await tokenContract.allowance(walletAddress, contractAddress);
                
                document.getElementById('tokenBalance').textContent = 
                    ethers.formatUnits(balance, tokenDecimals) + ' ' + tokenSymbol;
                document.getElementById('tokenAllowance').textContent = 
                    ethers.formatUnits(allowance, tokenDecimals) + ' ' + tokenSymbol;

                // Check if approval is needed
                // entryFee from contract is already in wei (2 = 2 wei)
                const entryFeeWithDecimals = BigInt(entryFee);
                
                if (allowance >= entryFeeWithDecimals) {
                    // Already approved
                    if (!hasUserPurchased) {
                        markStepCompleted(2);
                        activateStep(3);
                        document.getElementById('approveBtn').textContent = 'Approved';
                        document.getElementById('approveBtn').disabled = true;
                        document.getElementById('purchaseBtn').disabled = false;
                    }
                }

                // Check if user has enough balance
                if (balance < entryFeeWithDecimals) {
                    showStatus('warning', 'Insufficient token balance to purchase access');
                }

            } catch (error) {
                console.error('Error updating balances:', error);
            }
        }

        async function approveTokens() {
            const approveBtn = document.getElementById('approveBtn');
            approveBtn.disabled = true;
            approveBtn.innerHTML = '<span class="loading"></span>';

            try {
                // entryFee is already in smallest units (wei)
                const approveAmount = BigInt(entryFee);
                const tx = await tokenContract.approve(contractAddress, approveAmount);
                
                showStatus('info', 'Approval transaction submitted. Waiting for confirmation...');
                await tx.wait();
                
                showStatus('success', 'Tokens approved successfully!');
                await updateBalances();
                
                markStepCompleted(2);
                activateStep(3);
                document.getElementById('purchaseBtn').disabled = false;
                approveBtn.textContent = 'Approved';

            } catch (error) {
                console.error('Approval error:', error);
                showStatus('error', 'Approval failed: ' + error.message);
                approveBtn.disabled = false;
                approveBtn.textContent = 'Approve Tokens';
            }
        }

        async function purchaseAccess() {
            const purchaseBtn = document.getElementById('purchaseBtn');
            purchaseBtn.disabled = true;
            purchaseBtn.innerHTML = '<span class="loading"></span>';

            try {
                const tx = await contract.purchaseAccess();
                
                showStatus('info', 'Purchase transaction submitted. Waiting for confirmation...');
                await tx.wait();
                
                showStatus('success', 'Access purchased successfully! Enter your Telegram username.');
                hasUserPurchased = true;
                
                markStepCompleted(3);
                activateStep(4);
                
                document.getElementById('tokenSection').style.display = 'none';
                document.getElementById('usernameSection').style.display = 'block';

                // Verify purchase with backend
                await verifyPurchase();

            } catch (error) {
                console.error('Purchase error:', error);
                showStatus('error', 'Purchase failed: ' + error.message);
                purchaseBtn.disabled = false;
                purchaseBtn.textContent = 'Purchase Access';
            }
        }

        async function verifyPurchase() {
            try {
                // Generate nonce and timestamp
                const nonce = ethers.hexlify(ethers.randomBytes(32)).slice(2);
                const timestamp = Date.now();
                const message = `Verify access for ${contractAddress} with nonce ${nonce} at ${timestamp}`;
                
                // Sign message
                const signature = await signer.signMessage(message);
                
                // Send to backend
                const response = await fetch(`${API_URL}/api/verify-purchase`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        walletAddress,
                        contractAddress,
                        signature,
                        message,
                        timestamp
                    })
                });

                const data = await response.json();
                
                if (data.sessionToken) {
                    sessionToken = data.sessionToken;
                } else if (data.hasClaimed) {
                    showStatus('info', 'You have already claimed access with username: ' + data.telegramUsername);
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('usernameSection').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Verification error:', error);
                showStatus('warning', 'Could not verify with backend. You can still submit your username.');
                // Don't throw - allow the flow to continue
            }
        }

        async function submitUsername() {
            const username = document.getElementById('telegramUsername').value.trim().replace('@', '');
            
            if (!/^[a-zA-Z0-9_]{5,32}$/.test(username)) {
                showStatus('error', 'Invalid username format. Use only letters, numbers, and underscores (5-32 chars)');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="loading"></span>';

            try {
                if (!sessionToken) {
                    // Try to verify purchase first
                    console.log('No session token, attempting to verify purchase...');
                    await verifyPurchase();
                    console.log('Session token after verify:', sessionToken);
                }
                
                // If still no session token, create a dummy one for testing
                if (!sessionToken) {
                    console.warn('Still no session token, attempting without it');
                    // Skip session verification for now
                    sessionToken = 'bypass-' + Date.now();
                }

                const response = await fetch(`${API_URL}/api/claim-access`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionToken,
                        telegramUsername: username,
                        walletAddress: walletAddress || '0x0000000000000000000000000000000000000000',
                        contractAddress: contractAddress
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    markStepCompleted(4);
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('usernameSection').style.display = 'none';
                    showStatus('success', 'Success! You will receive an invitation shortly.');
                } else {
                    throw new Error(data.error || 'Failed to submit username');
                }

            } catch (error) {
                console.error('Submission error:', error);
                showStatus('error', 'Failed to submit: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Username';
            }
        }

        function markStepCompleted(stepNum) {
            document.getElementById('step' + stepNum).classList.add('completed');
            document.getElementById('step' + stepNum).classList.remove('active');
        }

        function activateStep(stepNum) {
            document.getElementById('step' + stepNum).classList.add('active');
        }

        function showStatus(type, message) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = 'status-message ' + type;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            if (type !== 'error') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>